<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Section Manager Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.1/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Section Manager Test Page</h1>
        
        <!-- Test Status -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Library Loading Status</h2>
            <div id="status" class="space-y-2"></div>
        </div>

        <!-- Simple Test Component -->
        <div x-data="testComponent()" x-init="init()" class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Alpine.js Test</h2>
            <button @click="count++" class="bg-blue-500 text-white px-4 py-2 rounded">
                Clicked: <span x-text="count"></span> times
            </button>
            <p class="mt-2 text-sm text-gray-600" x-show="count > 0">Alpine.js is working! ✅</p>
        </div>

        <!-- Section Manager Test -->
        <div x-data="sectionManagerTest()" x-init="init()" class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4">Section Manager Test</h2>
            
            <!-- Debug Info -->
            <div class="bg-gray-100 p-4 rounded mb-4">
                <h3 class="font-bold mb-2">Debug Info:</h3>
                <div class="text-sm space-y-1">
                    <p>Sections count: <span x-text="sections.length" class="font-mono"></span></p>
                    <p>Sortable instances: <span x-text="sortableInstances.length" class="font-mono"></span></p>
                </div>
            </div>

            <!-- Add Section Button -->
            <button @click="addTestSection()" 
                    class="mb-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                <i class="bi bi-plus-circle"></i> Add Test Section
            </button>

            <!-- Sections Container -->
            <div class="sections-container space-y-4" x-ref="sectionsContainer">
                <template x-for="(section, index) in sections" :key="section.id">
                    <div class="section-card bg-white rounded-lg shadow-sm border-2 border-gray-200 hover:border-blue-300 transition-all"
                         :data-section-id="section.id">
                        
                        <!-- Section Header -->
                        <div class="section-header flex items-center justify-between p-4 bg-gray-50 rounded-t-lg">
                            <div class="flex items-center space-x-3 flex-1">
                                <!-- Drag Handle -->
                                <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 px-2" 
                                     @click.stop
                                     role="button" 
                                     tabindex="0"
                                     title="Drag to reorder">
                                    <i class="bi bi-grip-vertical text-xl"></i>
                                </div>
                                
                                <!-- Expand/Collapse Icon -->
                                <button type="button" 
                                        class="text-gray-500 hover:text-gray-700"
                                        @click="toggleSection(section.id)"
                                        :title="section.expanded ? 'Collapse' : 'Expand'">
                                    <i class="bi text-lg" :class="section.expanded ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
                                </button>
                                
                                <!-- Section Name -->
                                <div class="flex-1 cursor-pointer" 
                                     @click="toggleSection(section.id)">
                                    <h3 class="text-lg font-semibold text-gray-800" x-text="section.name"></h3>
                                    <p class="text-sm text-gray-500" x-text="`Questions: ${section.questions.length}`"></p>
                                </div>
                            </div>
                            
                            <!-- Badge -->
                            <span class="badge bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium"
                                  x-text="`State: ${section.expanded ? 'Open' : 'Closed'}`"></span>
                        </div>
                        
                        <!-- Section Content (Collapsible) -->
                        <div x-show="section.expanded" 
                             x-transition
                             class="section-content border-t border-gray-200 p-4">
                            
                            <!-- Questions List -->
                            <div class="questions-list space-y-2" 
                                 :data-section-id="section.id"
                                 :x-ref="'questionsList' + section.id">
                                <template x-for="question in section.questions" :key="question.id">
                                    <div class="question-item bg-gray-50 p-3 rounded border border-gray-200 hover:border-blue-300 flex items-center"
                                         :data-question-id="question.id">
                                        <i class="bi bi-grip-vertical text-gray-400 cursor-move mr-3"></i>
                                        <span x-text="question.label"></span>
                                    </div>
                                </template>
                                
                                <!-- Empty State -->
                                <div x-show="section.questions.length === 0" class="text-center py-4 text-gray-400">
                                    No questions yet
                                </div>
                            </div>
                            
                            <!-- Add Question Button -->
                            <button @click="addTestQuestion(section.id)" 
                                    class="mt-3 w-full py-2 bg-blue-50 text-blue-600 rounded border-2 border-dashed border-blue-300 hover:bg-blue-100">
                                <i class="bi bi-plus-circle"></i> Add Test Question
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Test Results -->
            <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded p-4">
                <h3 class="font-bold mb-2">Test Results:</h3>
                <ul id="test-results" class="text-sm space-y-1"></ul>
            </div>
        </div>
    </div>

    <script>
        // Check libraries
        window.addEventListener('DOMContentLoaded', () => {
            const statusDiv = document.getElementById('status');
            const results = [];
            
            // Check Alpine.js
            if (typeof Alpine !== 'undefined') {
                results.push('<p class="text-green-600">✅ Alpine.js loaded</p>');
            } else {
                results.push('<p class="text-red-600">❌ Alpine.js NOT loaded</p>');
            }
            
            // Check Sortable.js
            if (typeof Sortable !== 'undefined') {
                results.push('<p class="text-green-600">✅ Sortable.js loaded</p>');
            } else {
                results.push('<p class="text-red-600">❌ Sortable.js NOT loaded</p>');
            }
            
            // Check Bootstrap Icons
            const hasIcons = document.querySelector('link[href*="bootstrap-icons"]');
            if (hasIcons) {
                results.push('<p class="text-green-600">✅ Bootstrap Icons loaded</p>');
            } else {
                results.push('<p class="text-red-600">❌ Bootstrap Icons NOT loaded</p>');
            }
            
            statusDiv.innerHTML = results.join('');
        });

        // Simple test component
        function testComponent() {
            return {
                count: 0,
                init() {
                    console.log('Test component initialized');
                }
            };
        }

        // Section Manager Test
        function sectionManagerTest() {
            return {
                sections: [],
                sortableInstances: [],
                nextId: 1,
                nextQuestionId: 1,
                
                init() {
                    console.log('Section Manager Test initialized');
                    this.logTest('Component initialized');
                    
                    // Add test sections
                    this.addTestSection();
                    this.addTestSection();
                    
                    // Initialize sortable after a delay
                    this.$nextTick(() => {
                        this.initSortable();
                        this.logTest('Sortable initialized');
                    });
                },
                
                addTestSection() {
                    const section = {
                        id: this.nextId++,
                        name: `Test Section ${this.nextId - 1}`,
                        expanded: false,
                        questions: []
                    };
                    this.sections.push(section);
                    console.log('Added section:', section);
                    this.logTest(`Added section: ${section.name}`);
                    
                    this.$nextTick(() => {
                        this.initSortable();
                    });
                },
                
                addTestQuestion(sectionId) {
                    const section = this.sections.find(s => s.id === sectionId);
                    if (section) {
                        const question = {
                            id: this.nextQuestionId++,
                            label: `Test Question ${this.nextQuestionId - 1}`
                        };
                        section.questions.push(question);
                        console.log('Added question:', question, 'to section:', sectionId);
                        this.logTest(`Added question to section ${sectionId}`);
                        
                        this.$nextTick(() => {
                            this.initSortable();
                        });
                    }
                },
                
                toggleSection(sectionId) {
                    const section = this.sections.find(s => s.id === sectionId);
                    if (section) {
                        const oldState = section.expanded;
                        section.expanded = !section.expanded;
                        console.log(`Toggle section ${sectionId}: ${oldState} -> ${section.expanded}`);
                        this.logTest(`Toggle section ${sectionId}: ${oldState ? 'closed' : 'opened'}`);
                        
                        // Reinitialize sortable for this section's questions
                        this.$nextTick(() => {
                            if (section.expanded) {
                                this.initSortable();
                                this.logTest(`Reinitialized sortable for section ${sectionId}`);
                            }
                        });
                    }
                },
                
                initSortable() {
                    this.$nextTick(() => {
                        // Destroy existing instances
                        this.sortableInstances.forEach(instance => {
                            try {
                                instance.destroy();
                            } catch (e) {
                                console.warn('Error destroying sortable:', e);
                            }
                        });
                        this.sortableInstances = [];
                        
                        // Initialize sortable for sections
                        if (this.$refs.sectionsContainer) {
                            try {
                                const sectionSortable = new Sortable(this.$refs.sectionsContainer, {
                                    handle: '.drag-handle',
                                    animation: 150,
                                    ghostClass: 'opacity-50',
                                    dragClass: 'shadow-2xl',
                                    draggable: '.section-card',
                                    onStart: (evt) => {
                                        console.log('Drag started:', evt.oldIndex);
                                        this.logTest(`Started dragging section ${evt.oldIndex + 1}`);
                                    },
                                    onEnd: (evt) => {
                                        console.log('Drag ended:', evt.oldIndex, '->', evt.newIndex);
                                        this.logTest(`Moved section from ${evt.oldIndex + 1} to ${evt.newIndex + 1}`);
                                        this.reorderSections(evt.oldIndex, evt.newIndex);
                                    }
                                });
                                this.sortableInstances.push(sectionSortable);
                                console.log('Section sortable initialized');
                            } catch (e) {
                                console.error('Error initializing section sortable:', e);
                                this.logTest('❌ Error initializing section sortable: ' + e.message);
                            }
                        }
                        
                        // Initialize sortable for each section's questions
                        this.sections.forEach(section => {
                            if (section.expanded) {
                                const listEl = this.$refs['questionsList' + section.id];
                                if (listEl) {
                                    try {
                                        const questionSortable = new Sortable(listEl, {
                                            group: 'questions',
                                            animation: 150,
                                            ghostClass: 'opacity-50',
                                            dragClass: 'shadow-2xl',
                                            draggable: '.question-item',
                                            handle: '.bi-grip-vertical',
                                            onStart: (evt) => {
                                                console.log('Question drag started');
                                                this.logTest('Started dragging question');
                                            },
                                            onEnd: (evt) => {
                                                console.log('Question drag ended');
                                                this.logTest('Moved question between sections');
                                            }
                                        });
                                        this.sortableInstances.push(questionSortable);
                                        console.log('Question sortable initialized for section:', section.id);
                                    } catch (e) {
                                        console.error('Error initializing question sortable:', e);
                                        this.logTest('❌ Error initializing question sortable: ' + e.message);
                                    }
                                }
                            }
                        });
                        
                        console.log('Total sortable instances:', this.sortableInstances.length);
                    });
                },
                
                reorderSections(oldIndex, newIndex) {
                    const section = this.sections[oldIndex];
                    this.sections.splice(oldIndex, 1);
                    this.sections.splice(newIndex, 0, section);
                    console.log('Sections reordered');
                },
                
                logTest(message) {
                    const resultsUl = document.getElementById('test-results');
                    if (resultsUl) {
                        const li = document.createElement('li');
                        li.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                        resultsUl.appendChild(li);
                        
                        // Keep only last 10 messages
                        while (resultsUl.children.length > 10) {
                            resultsUl.removeChild(resultsUl.firstChild);
                        }
                    }
                }
            };
        }

        // Global error handler
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.message, e.filename, e.lineno);
            const resultsUl = document.getElementById('test-results');
            if (resultsUl) {
                const li = document.createElement('li');
                li.className = 'text-red-600';
                li.textContent = `❌ Error: ${e.message}`;
                resultsUl.appendChild(li);
            }
        });

        // Log Alpine.js initialization
        document.addEventListener('alpine:init', () => {
            console.log('Alpine.js initialized');
        });
    </script>
</body>
</html>
