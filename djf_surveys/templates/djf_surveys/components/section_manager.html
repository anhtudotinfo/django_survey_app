{% load i18n %}
<!-- Section Manager Component -->
<div x-data="sectionManager()" x-init="init()" class="section-manager mb-8" data-survey-slug="{{ object.slug }}">
    
    <!-- Section List -->
    <div class="sections-container space-y-4" x-ref="sectionsContainer">
        <template x-for="(section, index) in sections" :key="section.id">
            <div class="section-card bg-white rounded-lg shadow-sm border-2 border-gray-200 hover:border-blue-300 transition-all"
                 :data-section-id="section.id">
                
                <!-- Section Header -->
                <div class="section-header flex items-center justify-between p-4 bg-gray-50 rounded-t-lg">
                    <div class="flex items-center space-x-3 flex-1">
                        <!-- Expand/Collapse Icon -->
                        <button type="button" 
                                class="text-gray-500 hover:text-gray-700"
                                :aria-label="section.expanded ? '{% trans 'Collapse section' %}' : '{% trans 'Expand section' %}'"
                                :aria-expanded="section.expanded"
                                @click="toggleSection(section.id)">
                            <i class="bi text-lg" :class="section.expanded ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
                        </button>
                        
                        <!-- Section Name/Edit -->
                        <div class="flex-1 cursor-pointer" x-show="!section.editing" 
                             @click="toggleSection(section.id)"
                             @dblclick.stop="startEditSection(section.id)">
                            <h3 class="text-lg font-semibold text-gray-800" x-text="section.name"></h3>
                            <p class="text-sm text-gray-500" x-show="section.description" x-text="section.description"></p>
                        </div>
                        
                        <!-- Inline Edit Form -->
                        <div class="flex-1 space-y-2" x-show="section.editing" @click.stop>
                            <input type="text" x-model="section.name" 
                                   @blur="saveSection(section)" 
                                   @keydown.enter="saveSection(section)"
                                   @keydown.escape="cancelEdit(section)"
                                   placeholder="{% trans 'Section Name' %}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <textarea x-model="section.description" 
                                      @blur="saveSection(section)"
                                      placeholder="{% trans 'Description (optional)' %}"
                                      rows="2"
                                      class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                    
                    <!-- Section Actions -->
                    <div class="flex items-center space-x-3">
                        <!-- Question Count Badge -->
                        <span class="badge bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                            <i class="bi bi-question-circle"></i>
                            <span x-text="section.questions.length"></span>
                        </span>
                        
                        <!-- Edit Button -->
                        <button @click.stop="startEditSection(section.id)" 
                                class="text-gray-500 hover:text-blue-600 p-2"
                                :aria-label="'{% trans 'Edit section' %} ' + section.name"
                                title="{% trans 'Edit section' %}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        
                        <!-- Delete Button -->
                        <button @click.stop="deleteSection(section.id)" 
                                class="text-gray-500 hover:text-red-600 p-2"
                                :aria-label="'{% trans 'Delete section' %} ' + section.name"
                                title="{% trans 'Delete section' %}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Section Content (Collapsible) -->
                <div x-show="section.expanded" 
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 transform scale-y-95"
                     x-transition:enter-end="opacity-100 transform scale-y-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100 transform scale-y-100"
                     x-transition:leave-end="opacity-0 transform scale-y-95"
                     class="section-content border-t border-gray-200 p-4">
                    
                    <!-- Questions List -->
                    <div class="questions-list space-y-2 mb-4" 
                         :data-section-id="section.id"
                         :x-ref="'questionsList' + section.id">
                        <template x-for="question in section.questions" :key="question.id">
                            <div class="question-item bg-gray-50 p-3 rounded border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all flex items-center justify-between"
                                 :data-question-id="question.id">
                                <div class="flex items-center space-x-3 flex-1">
                                    <i class="bi bi-grip-vertical text-gray-400 cursor-move"></i>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-800" x-text="question.label"></p>
                                        <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded" x-text="question.type_display"></span>
                                        <span x-show="question.required" class="text-xs text-red-500 ml-2">*{% trans 'Required' %}</span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <a :href="'/admin/question/edit/' + question.id + '/'" 
                                       class="text-blue-500 hover:text-blue-700 p-2">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button @click="deleteQuestion(question.id)" 
                                            class="text-red-500 hover:text-red-700 p-2">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Empty State -->
                        <div x-show="section.questions.length === 0" class="text-center py-8 text-gray-400">
                            <i class="bi bi-inbox text-4xl"></i>
                            <p class="mt-2">{% trans "No questions in this section yet" %}</p>
                        </div>
                    </div>
                    
                    <!-- Add Question Button -->
                    <button @click="addQuestion(section.id)" 
                            data-te-toggle="modal" 
                            data-te-target="#addQuestion"
                            class="w-full border-2 border-dashed border-gray-300 rounded-lg p-4 text-gray-500 hover:border-blue-500 hover:text-blue-500 hover:bg-blue-50 transition-all">
                        <i class="bi bi-plus-circle text-xl"></i>
                        <span class="ml-2 font-medium">{% trans "Add Question" %}</span>
                    </button>
                </div>
            </div>
        </template>
        
        <!-- Empty State for Sections -->
        <div x-show="sections.length === 0" class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
            <i class="bi bi-folder-plus text-5xl text-gray-400"></i>
            <p class="mt-4 text-gray-600 text-lg">{% trans "No sections yet. Create your first section!" %}</p>
        </div>
    </div>
    
    <!-- Unassigned Questions Area -->
    <div x-show="unassignedQuestions.length > 0" 
         class="unassigned-questions mt-6 bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
        <h3 class="text-lg font-semibold mb-3 text-yellow-900">
            <i class="bi bi-exclamation-triangle text-yellow-600"></i>
            {% trans "Unassigned Questions" %}
            <span class="badge bg-yellow-200 text-yellow-800 px-3 py-1 rounded-full text-sm ml-2"
                  x-text="unassignedQuestions.length"></span>
        </h3>
        <p class="text-sm text-yellow-700 mb-3">{% trans "These questions are not assigned to any section. Drag them into a section or they will appear at the end of the survey." %}</p>
        
        <div class="questions-list space-y-2">
            <template x-for="question in unassignedQuestions" :key="question.id">
                <div class="question-item bg-white p-3 rounded border border-yellow-300 hover:border-yellow-500 transition-all">
                    <div class="flex items-center justify-between gap-3">
                        <!-- Question Info -->
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-800 truncate" x-text="question.label"></p>
                            <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded" x-text="question.type_display"></span>
                        </div>
                        
                        <!-- Assign to Section Dropdown -->
                        <div class="flex items-center gap-2">
                            <select @change="moveQuestionToSection(question.id, $event.target.value, null)"
                                    class="text-sm border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">{% trans "Assign to..." %}</option>
                                <template x-for="s in sections" :key="s.id">
                                    <option :value="s.id" x-text="s.name"></option>
                                </template>
                            </select>
                            
                            <a :href="'/dashboard/question/edit/' + question.id + '/'" 
                               class="text-blue-500 hover:text-blue-700 p-2"
                               title="{% trans 'Edit' %}">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <button @click="deleteQuestion(question.id)" 
                                    class="text-red-500 hover:text-red-700 p-2"
                                    title="{% trans 'Delete' %}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
    
    <!-- Add Section Button -->
    <button @click="addSection()" 
            class="mt-6 w-full bg-blue-500 text-white py-4 rounded-lg hover:bg-blue-600 active:bg-blue-700 transition-all shadow-md hover:shadow-lg font-medium text-lg">
        <i class="bi bi-plus-circle text-xl"></i>
        <span class="ml-2">{% trans "Add Section" %}</span>
    </button>
    
    <!-- Loading Indicator -->
    <div x-show="loading" 
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         role="status"
         aria-live="polite"
         aria-label="{% trans 'Loading survey sections' %}">
        <div class="bg-white rounded-lg p-6 shadow-xl">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto" 
                 aria-hidden="true"></div>
            <p class="mt-4 text-gray-700">{% trans "Loading..." %}</p>
        </div>
    </div>
</div>

<script>
function sectionManager() {
    return {
        sections: [],
        unassignedQuestions: [],
        surveySlug: '',
        loading: false,
        
        async init() {
            console.log('=== Section Manager Init ===');
            this.surveySlug = this.$el.dataset.surveySlug;
            console.log('Survey slug:', this.surveySlug);
            
            await this.loadData();
            console.log('Data loaded, sections:', this.sections.length);
        },
        
        async loadData(preserveState = false) {
            this.loading = true;
            try {
                const response = await fetch(`/dashboard/api/survey/${this.surveySlug}/sections/`);
                const data = await response.json();
                
                // Preserve expanded/editing state
                const stateMap = new Map();
                if (preserveState) {
                    this.sections.forEach(s => {
                        stateMap.set(s.id, {
                            expanded: s.expanded,
                            editing: s.editing
                        });
                    });
                }
                
                this.sections = data.sections.map(s => {
                    const savedState = stateMap.get(s.id);
                    return {
                        ...s, 
                        expanded: savedState ? savedState.expanded : false, 
                        editing: savedState ? savedState.editing : false,
                        originalName: s.name,
                        originalDescription: s.description
                    };
                });
                this.unassignedQuestions = data.unassigned_questions || [];
            } catch (error) {
                console.error('Failed to load sections:', error);
                alert('{% trans "Failed to load survey sections" %}');
            } finally {
                this.loading = false;
            }
        },
        

        
        toggleSection(sectionId) {
            console.log('=== Toggle Section ===', sectionId);
            const section = this.sections.find(s => s.id === sectionId);
            console.log('Found section:', section);
            
            if (section && !section.editing) {
                const oldState = section.expanded;
                section.expanded = !section.expanded;
                console.log('State changed:', oldState, '->', section.expanded);
            } else {
                console.log('Cannot toggle - section editing or not found');
            }
        },
        
        startEditSection(sectionId) {
            const section = this.sections.find(s => s.id === sectionId);
            if (section) {
                section.editing = true;
                section.originalName = section.name;
                section.originalDescription = section.description;
            }
        },
        
        async saveSection(section) {
            section.editing = false;
            try {
                const response = await fetch(`/dashboard/api/section/${section.id}/update/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify({
                        name: section.name,
                        description: section.description
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Save failed');
                }
            } catch (error) {
                alert('{% trans "Failed to save section" %}');
                section.name = section.originalName;
                section.description = section.originalDescription;
            }
        },
        
        cancelEdit(section) {
            section.editing = false;
            section.name = section.originalName;
            section.description = section.originalDescription;
        },
        
        async addSection() {
            try {
                const response = await fetch('/dashboard/api/section/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify({
                        survey_slug: this.surveySlug,
                        name: '{% trans "New Section" %}',
                        ordering: this.sections.length
                    })
                });
                
                if (response.ok) {
                    const newSection = await response.json();
                    this.sections.push({
                        ...newSection, 
                        expanded: true, 
                        editing: false, 
                        questions: []
                    });
                    this.$nextTick(() => this.initSortable());
                }
            } catch (error) {
                alert('{% trans "Failed to create section" %}');
            }
        },
        
        async deleteSection(sectionId) {
            if (!confirm('{% trans "Delete this section? Questions will become unassigned." %}')) return;
            
            try {
                const response = await fetch(`/dashboard/api/section/${sectionId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': this.getCsrfToken()
                    }
                });
                
                if (response.ok) {
                    await this.loadData(true);  // Preserve state
                    this.$nextTick(() => this.initSortable());
                }
            } catch (error) {
                alert('{% trans "Failed to delete section" %}');
            }
        },
        

        
        async moveQuestionToSection(questionId, targetSectionId, currentSectionId) {
            console.log('Move question', questionId, 'from', currentSectionId, 'to', targetSectionId);
            
            // If same section or empty selection, do nothing
            if (targetSectionId === '' || targetSectionId == currentSectionId) {
                // Reset dropdown
                event.target.value = '';
                return;
            }
            
            // Convert "unassigned" to null
            const sectionId = targetSectionId === 'unassigned' ? null : targetSectionId;
            
            try {
                const response = await fetch(`/dashboard/api/question/${questionId}/move/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify({
                        section_id: sectionId,
                        ordering: 0
                    })
                });
                
                if (response.ok) {
                    await this.loadData(true);  // Preserve state
                    // Show success message
                    const targetSection = this.sections.find(s => s.id == targetSectionId);
                    const targetName = targetSection ? targetSection.name : 'Unassigned';
                    console.log('Question moved to', targetName);
                } else {
                    alert('{% trans "Failed to move question" %}');
                }
            } catch (error) {
                console.error('Error moving question:', error);
                alert('{% trans "Failed to move question" %}');
            }
            
            // Reset dropdown
            event.target.value = '';
        },
        
        async moveQuestion(questionId, targetSectionId, newIndex) {
            // Legacy method for API compatibility
            return this.moveQuestionToSection(questionId, targetSectionId, null);
        },
        
        addQuestion(sectionId) {
            console.log('Add question to section:', sectionId);
            // Store section ID in sessionStorage AND in a hidden input field
            sessionStorage.setItem('currentSectionId', sectionId);
            
            // Create hidden input in form if modal exists
            const modal = document.getElementById('addQuestion');
            if (modal) {
                let input = modal.querySelector('input[name="target_section_id"]');
                if (!input) {
                    input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'target_section_id';
                    modal.appendChild(input);
                }
                input.value = sectionId;
                console.log('Set target_section_id to', sectionId);
            }
        },
        
        async deleteQuestion(questionId) {
            if (!confirm('{% trans "Delete this question?" %}')) return;
            
            try {
                const response = await fetch(`/dashboard/api/question/${questionId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': this.getCsrfToken()
                    }
                });
                
                if (response.ok) {
                    await this.loadData(true);  // Preserve state
                    this.$nextTick(() => this.initSortable());
                }
            } catch (error) {
                alert('{% trans "Failed to delete question" %}');
            }
        },
        
        getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }
    }
}
</script>
