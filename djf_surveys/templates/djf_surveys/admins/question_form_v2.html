{% extends 'djf_surveys/admins/form.html' %}
{% load i18n %}

{% block extra_content %}

<!-- DEBUG MARKER -->
<div style="background: yellow; padding: 10px; margin: 10px 0; border: 3px solid red;">
    <h2 style="color: red; font-size: 20px;">üîß DEBUG: question_form_v2.html is loading!</h2>
    <p>If you see this, the template is working.</p>
</div>

<!-- Validation Rules Section -->
<div id="validationSection" class="mt-6 p-6 bg-gradient-to-r from-green-50 to-teal-50 rounded-lg border-2 border-green-200">
    <div class="flex items-center mb-4">
        <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h4 class="text-lg font-bold text-green-900">{% trans "Validation Rules" %}</h4>
    </div>
    
    <p class="text-sm text-gray-700 mb-4">
        {% trans "Configure validation rules for this question. Leave blank to use default values." %}
    </p>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Min Length -->
        <div class="bg-white p-4 rounded-lg shadow-sm">
            <label for="id_min_length" class="block text-sm font-medium text-gray-700 mb-2">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>
                </svg>
                {% trans "Minimum Length" %}
            </label>
            {{ form.min_length }}
            <p class="text-xs text-gray-500 mt-1">{{ form.min_length.help_text }}</p>
        </div>
        
        <!-- Max Length -->
        <div class="bg-white p-4 rounded-lg shadow-sm">
            <label for="id_max_length" class="block text-sm font-medium text-gray-700 mb-2">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                </svg>
                {% trans "Maximum Length" %}
            </label>
            {{ form.max_length }}
            <p class="text-xs text-gray-500 mt-1">{{ form.max_length.help_text }}</p>
        </div>
        
        <!-- Regex Pattern -->
        <div class="bg-white p-4 rounded-lg shadow-sm md:col-span-2">
            <label for="id_regex_pattern" class="block text-sm font-medium text-gray-700 mb-2">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                </svg>
                {% trans "Regex Pattern" %}
            </label>
            {{ form.regex_pattern }}
            <p class="text-xs text-gray-500 mt-1">{{ form.regex_pattern.help_text }}</p>
            <div class="mt-2 p-2 bg-blue-50 rounded text-xs">
                <strong>{% trans "Examples:" %}</strong>
                <ul class="list-disc ml-4 mt-1">
                    <li><code>^\d+$</code> - Only numbers</li>
                    <li><code>^[A-Z]+$</code> - Only uppercase letters</li>
                    <li><code>^[a-zA-Z0-9]+$</code> - Alphanumeric only</li>
                    <li><code>^\d{4}-\d{2}-\d{2}$</code> - Date format (YYYY-MM-DD)</li>
                </ul>
            </div>
        </div>
        
        <!-- Validation Message -->
        <div class="bg-white p-4 rounded-lg shadow-sm md:col-span-2">
            <label for="id_validation_message" class="block text-sm font-medium text-gray-700 mb-2">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                {% trans "Custom Validation Message" %}
            </label>
            {{ form.validation_message }}
            <p class="text-xs text-gray-500 mt-1">{{ form.validation_message.help_text }}</p>
        </div>
    </div>
    
    <!-- Default Values Info -->
    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
        <div class="flex">
            <svg class="w-5 h-5 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="text-sm text-yellow-800">
                <strong>{% trans "Default Values:" %}</strong>
                <ul class="list-disc ml-4 mt-1">
                    <li>Text: 0-500 characters</li>
                    <li>Text Area: 0-5000 characters</li>
                    <li>Email: 0-254 characters, email format</li>
                    <li>URL: 0-2048 characters, URL format</li>
                    <li>Number: numeric format</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Section Branching Toggle (Only for Radio Questions) -->
<div id="branchingSection" class="mt-6 p-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border-2 border-purple-200">
    <div class="flex items-center mb-4">
        <svg class="w-6 h-6 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
        </svg>
        <h4 class="text-lg font-bold text-purple-900">{% trans "Section Branching" %}</h4>
    </div>
    
    <p class="text-sm text-gray-700 mb-4">
        {% trans "Configure conditional navigation: send users to different sections based on their choice." %}
    </p>
    
    <!-- Enable Branching Toggle -->
    <div class="mb-4 p-4 bg-white rounded-lg shadow-sm">
        <label class="flex items-center cursor-pointer">
            <input type="checkbox" name="enable_branching" id="enableBranching" 
                   class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500"
                   {% if form.instance.enable_branching %}checked{% endif %}>
            <span class="ml-3 font-medium text-gray-900">{% trans "Enable section branching" %}</span>
        </label>
        <p class="text-sm text-gray-500 mt-2 ml-8">
            {% trans "When enabled, a dropdown will appear next to each answer to select the target section" %}
        </p>
    </div>
    
    <!-- Branching configuration panel - ALWAYS VISIBLE FOR TESTING -->
    <div id="branchConfigPanel" style="display: block; border: 3px solid purple; padding: 10px; margin: 10px 0;">
        <div class="mt-4 p-4 bg-white rounded-lg shadow-sm border border-purple-200">
            <h5 class="font-semibold text-gray-800 mb-3">Configure navigation for each answer:</h5>
            
            <div id="branchOptions" class="space-y-3">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const TYPE_FIELD_RADIO = 2;
    const typeFieldSelect = document.getElementById('id_type_field');
    const branchingSection = document.getElementById('branchingSection');
    const enableBranchingCheckbox = document.getElementById('enableBranching');
    
    // Get sections from template context
    const sections = {{ sections|safe }};
    const currentBranchConfig = {{ current_branch_config|default:"{}"|safe }};
    
    let sectionsArray = [];
    if (Array.isArray(sections)) {
        sectionsArray = sections;
    } else if (typeof sections === 'object') {
        sectionsArray = Object.values(sections);
    }
    
    console.log('='.repeat(60));
    console.log('üìä BRANCHING UI DEBUG INFO');
    console.log('='.repeat(60));
    console.log('Sections raw:', sections);
    console.log('Sections array:', sectionsArray);
    console.log('Sections count:', sectionsArray.length);
    console.log('Current branch config:', currentBranchConfig);
    console.log('='.repeat(60));
    
    // Initialize
    function init() {
        console.log('üöÄ Initializing branching UI...');
        
        if (!typeFieldSelect) {
            console.warn('‚ö†Ô∏è  Type field select not found');
            // Still populate even without type field
            setTimeout(updateBranchOptions, 500);
            return;
        }
        
        updateBranchingVisibility();
        
        if (typeFieldSelect) {
            typeFieldSelect.addEventListener('change', function() {
                console.log('üìù Type field changed');
                updateBranchingVisibility();
                updateBranchOptions();
            });
        }
        
        if (enableBranchingCheckbox) {
            enableBranchingCheckbox.addEventListener('change', toggleBranchConfig);
        }
        
        // Listen to choices field changes
        const choicesInput = document.querySelector('[name="choices"]');
        if (choicesInput) {
            choicesInput.addEventListener('input', () => {
                if (enableBranchingCheckbox && enableBranchingCheckbox.checked) {
                    updateBranchOptions();
                }
            });
        }
        
        // Initial setup
        console.log('‚è∞ Initial setup...');
        console.log('üì¶ Checkbox element:', enableBranchingCheckbox);
        console.log('üì¶ Checkbox checked?', enableBranchingCheckbox ? enableBranchingCheckbox.checked : 'NULL');
        
        // Force show panel for testing
        const branchConfigPanel = document.getElementById('branchConfigPanel');
        console.log('üì¶ Panel element:', branchConfigPanel);
        
        toggleBranchConfig();
        
        // Force update immediately if branching is enabled
        if (enableBranchingCheckbox && enableBranchingCheckbox.checked) {
            console.log('‚ö° Checkbox is already checked - updating now!');
            updateBranchOptions();
        }
        
        // Also update after delay
        setTimeout(() => {
            console.log('‚è∞ Delayed update...');
            if (enableBranchingCheckbox && enableBranchingCheckbox.checked) {
                updateBranchOptions();
            }
        }, 1000);
    }
    
    function updateBranchingVisibility() {
        const isRadio = typeFieldSelect && typeFieldSelect.value == TYPE_FIELD_RADIO;
        if (branchingSection) {
            branchingSection.style.display = isRadio ? 'block' : 'none';
        }
    }
    
    function toggleBranchConfig() {
        const branchConfigPanel = document.getElementById('branchConfigPanel');
        const isEnabled = enableBranchingCheckbox && enableBranchingCheckbox.checked;
        
        console.log(`üîÑ Toggle branching: ${isEnabled ? 'ON' : 'OFF'}`);
        
        if (branchConfigPanel) {
            branchConfigPanel.style.display = isEnabled ? 'block' : 'none';
            if (isEnabled) {
                updateBranchOptions();
            }
        }
    }
    
    function getChoices() {
        const choicesInput = document.querySelector('[name="choices"]');
        console.log('üîç getChoices() - choicesInput:', choicesInput);
        console.log('üîç getChoices() - value:', choicesInput ? choicesInput.value : 'NULL');
        
        if (choicesInput && choicesInput.value) {
            const choices = choicesInput.value.split(',')
                .map(c => c.trim())
                .filter(c => c !== '');
            console.log('üîç getChoices() - parsed:', choices);
            return choices;
        }
        console.log('üîç getChoices() - returning empty array');
        return [];
    }
    
    function updateBranchOptions() {
        console.log('üîÑ updateBranchOptions() called');
        
        const branchOptionsContainer = document.getElementById('branchOptions');
        if (!branchOptionsContainer) return;
        
        const choices = getChoices();
        console.log(`üì¶ Found ${choices.length} choices:`, choices);
        
        if (choices.length === 0) {
            branchOptionsContainer.innerHTML = '<p class="text-gray-500 italic text-sm">No answers yet. Please add choices above.</p>';
            return;
        }
        
        if (!sectionsArray || sectionsArray.length === 0) {
            console.warn('‚ö†Ô∏è  No sections available');
            branchOptionsContainer.innerHTML = '<p class="text-red-500 text-sm">No sections found. Please create sections first.</p>';
            return;
        }
        
        console.log(`‚úÖ Creating dropdowns for ${choices.length} choices with ${sectionsArray.length} sections`);
        
        branchOptionsContainer.innerHTML = '';
        
        choices.forEach((choice, index) => {
            const choiceKey = choice.toLowerCase().replace(/\s+/g, '_').replace(/[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ]/g, 'a')
                                   .replace(/[√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ]/g, 'e').replace(/[√¨√≠·ªã·ªâƒ©]/g, 'i')
                                   .replace(/[√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°]/g, 'o').replace(/[√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ]/g, 'u')
                                   .replace(/[·ª≥√Ω·ªµ·ª∑·ªπ]/g, 'y').replace(/ƒë/g, 'd');
            const currentTarget = currentBranchConfig[choiceKey] || '';
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 hover:border-purple-300 transition';
            
            optionDiv.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center font-bold text-sm">
                    ${index + 1}
                </div>
                <div class="flex-grow">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        "${choice}"
                    </label>
                    <select name="branch_target_${choiceKey}" 
                            class="branch-target-select w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white">
                        <option value="">‚û°Ô∏è Continue to next section</option>
                        <option value="0" ${currentTarget === 0 ? 'selected' : ''}>üèÅ End survey</option>
                        ${sectionsArray.map(section => `
                            <option value="${section.id}" ${currentTarget == section.id ? 'selected' : ''}>
                                üìç ${section.name}
                            </option>
                        `).join('')}
                    </select>
                </div>
            `;
            
            branchOptionsContainer.appendChild(optionDiv);
        });
        
        console.log(`‚úÖ Created ${choices.length} branch option dropdowns`);
    }
    
    // Make it globally available for widget to call
    window.updateBranchOptions = updateBranchOptions;
    
    // Override global function to update when choices change from widget
    window.updateBranchingSelectors = function() {
        if (enableBranchingCheckbox && enableBranchingCheckbox.checked) {
            setTimeout(updateBranchOptions, 100);
        }
    }
    
    // Initialize on DOM load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
{% endblock %}
