{% extends 'djf_surveys/master.html' %}
{% load static i18n %}

{% block extra_css %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="{% static 'djf_surveys/te-starter/css/tw-elements.min.css' %}">
    <link rel="stylesheet" href="{% static 'djf_surveys/css/rating.css' %}"/>
{% endblock extra_css%}

{% block content %}
    <div class="container px-5 py-5 ">

        <section>
            <div class="py-6 lg:items-end justify-between flex">
                <h2 class="max-w-xl text-2xl font-bold sm:text-3xl">
                    {% trans "Summary" %} - {{ object.name }}
                </h2>

                <div class="flex -space-x-4 hover:space-x-1 float-right">
                    <a href="{% url 'djf_surveys:download_survey_files' object.slug %}"
                       class="z-20 block p-4 text-blue-700 transition-all bg-blue-100 border-2 border-white rounded-full active:bg-blue-50 hover:scale-110 focus:outline-none focus:ring"
                       type="button" title="{% trans 'Download All Files' %}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                    </a>
                    
                    <a href="{% url 'djf_surveys:detail' object.slug %}"
                       class="z-20 block p-4 text-green-700 transition-all bg-green-100 border-2 border-white rounded-full active:bg-green-50 hover:scale-110 focus:outline-none focus:ring"
                       type="button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </section>

        <form method="GET" action="" class="space-y-6 mb-2" id="filterForm">
            <!-- Date Range Filters (New) -->
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <h3 class="text-lg font-semibold mb-3 text-blue-800">{% trans "Date Range Filter" %}</h3>
                <div class="flex flex-col md:flex-row md:items-end md:space-x-4 space-y-4 md:space-y-0">
                    <div class="flex flex-col flex-1">
                        <label for="from_date" class="mb-2 text-gray-700 font-semibold">{% trans "From Date" %}:</label>
                        <input type="date" name="from_date" id="from_date" value="{{ from_date }}" 
                               class="block w-full bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 p-2">
                    </div>
                    
                    <div class="flex flex-col flex-1">
                        <label for="to_date" class="mb-2 text-gray-700 font-semibold">{% trans "To Date" %}:</label>
                        <input type="date" name="to_date" id="to_date" value="{{ to_date }}" 
                               class="block w-full bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 p-2">
                    </div>
                    
                    <div class="flex flex-col">
                        <button type="button" onclick="clearDateRange()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">
                            {% trans "Clear" %}
                        </button>
                    </div>
                </div>
                <p class="text-xs text-gray-600 mt-2">{% trans "Note: Date range filter takes priority over Year/Month filters" %}</p>
            </div>
            
            <!-- Original Filters -->
            <div class="flex flex-col md:flex-row md:items-end md:space-x-4 space-y-4 md:space-y-0">
                <!-- Select Course -->
                <div class="flex flex-col flex-1">
                    <label for="direction" class="mb-2 text-gray-700 font-semibold">{% trans "Select Course" %}:</label>
                    <select name="direction" id="direction" class="block w-full bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 p-2">
                        <option value="">{% trans "All Courses" %}</option>
                        {% for direction in directions %}
                            <option value="{{ direction.id }}" {% if selected_direction and direction.id == selected_direction.id %}selected{% endif %}>
                                {{ direction.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Select Year -->
                <div class="flex flex-col flex-1">
                    <label for="year" class="mb-2 text-gray-700 font-semibold">{% trans "Select Year" %}:</label>
                    <select id="year" name="year" class="block w-full bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 p-2">
                        <option value="">{% trans "All Years" %}</option>
                        {% for year in years %}
                            <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>
                                {{ year }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Select Month -->
                <div class="flex flex-col flex-1">
                    <label for="month" class="mb-2 text-gray-700 font-semibold">{% trans "Select Month" %}:</label>
                    <select id="month" name="month" class="block w-full bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 p-2">
                        <option value="">{% trans "All Months" %}</option>
                        {% for month in months %}
                            <option value="{{ month.value }}" {% if month.value == selected_month %}selected{% endif %}>
                                {{ month.name}}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- Question Filter (New) -->
            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <h3 class="text-lg font-semibold mb-3 text-green-800">{% trans "Question Filter" %}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-60 overflow-y-auto">
                    {% for question in all_questions %}
                        <label class="flex items-start space-x-2 p-2 hover:bg-green-100 rounded cursor-pointer">
                            <input type="checkbox" name="questions" value="{{ question.id }}" 
                                   {% if question.id in selected_questions %}checked{% endif %}
                                   class="mt-1 focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300 rounded">
                            <span class="text-sm text-gray-700">{{ question.label }}</span>
                        </label>
                    {% endfor %}
                </div>
                <div class="mt-3 flex space-x-2">
                    <button type="button" onclick="selectAllQuestions()" class="text-sm bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded">
                        {% trans "Select All" %}
                    </button>
                    <button type="button" onclick="deselectAllQuestions()" class="text-sm bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded">
                        {% trans "Deselect All" %}
                    </button>
                </div>
                <p class="text-xs text-gray-600 mt-2">{% trans "Leave empty to show all questions" %}</p>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex flex-col md:flex-row md:items-center md:space-x-4 space-y-4 md:space-y-0">
                <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full" type="submit">
                    <i class="bi bi-filter"></i> {% trans "Apply Filters" %}
                </button>
                
                <button type="button" onclick="downloadFiltered()" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full">
                    <i class="bi bi-download"></i> {% trans "Download Filtered Data" %}
                </button>
                
                <button type="button" onclick="resetFilters()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full">
                    <i class="bi bi-arrow-counterclockwise"></i> {% trans "Reset All Filters" %}
                </button>
            </div>
        </form>


        <div class="grid xs:grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {{ summary.generate_questions|safe }}
        </div>

        <div class="mt-8">
            <script src="{% static 'djf_surveys/js/apexcharts.js' %}"></script>
            {{ summary.generate_question2|safe }}
        </div>
    </div>

{% endblock content%}

{% block extra_js %}
<script>
// Clear date range inputs
function clearDateRange() {
    document.getElementById('from_date').value = '';
    document.getElementById('to_date').value = '';
}

// Select all questions
function selectAllQuestions() {
    const checkboxes = document.querySelectorAll('input[name="questions"]');
    checkboxes.forEach(cb => cb.checked = true);
}

// Deselect all questions
function deselectAllQuestions() {
    const checkboxes = document.querySelectorAll('input[name="questions"]');
    checkboxes.forEach(cb => cb.checked = false);
}

// Reset all filters
function resetFilters() {
    // Clear form
    document.getElementById('filterForm').reset();
    // Redirect to page without query params
    window.location.href = window.location.pathname;
}

// Download filtered data
function downloadFiltered() {
    const form = document.getElementById('filterForm');
    const formData = new FormData(form);
    
    // Build query string
    const params = new URLSearchParams();
    for (const [key, value] of formData) {
        if (value) {
            params.append(key, value);
        }
    }
    
    // Change URL to download endpoint
    const downloadUrl = "{% url 'djf_surveys:admin_download_filtered_survey' object.slug %}" + '?' + params.toString();
    window.location.href = downloadUrl;
}
</script>
{% endblock %}

